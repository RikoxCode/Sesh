#!/usr/bin/env sh
set -e

exists() { [ -e "$1" ]; }

echo "[pre-commit] lint-staged"
npx --no-install lint-staged

echo "[pre-commit] prettier check (root)"
if ! npm run -s format:check; then
  echo "[pre-commit] applying prettier fixes (root)"
  npm run -s format
  git add -A
  echo "[pre-commit] formatting applied. commit again."
  exit 1
fi

if exists apps/frontend/package.json; then
  echo "[pre-commit] frontend"
  if ! npm --prefix apps/frontend run -s precommit; then
    echo "[pre-commit] frontend precommit failed → running format"
    npm --prefix apps/frontend run -s format || true
    git add -A
    echo "[pre-commit] frontend fixed. commit again."
    exit 1
  fi
else
  echo "[pre-commit] skip frontend (missing)"
fi

if exists apps/backend/composer.json; then
  echo "[pre-commit] backend"
  if ! (cd apps/backend && composer run -q precommit); then
    echo "[pre-commit] backend precommit failed → running pint"
    (cd apps/backend && php artisan pint) || true
    git add -A
    echo "[pre-commit] backend fixed. commit again."
    exit 1
  fi
else
  echo "[pre-commit] skip backend (missing)"
fi

echo "[pre-commit] OK"
